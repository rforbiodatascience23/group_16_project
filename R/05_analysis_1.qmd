---
format:
  html: {}
---

# Analysis of data

1.  Load all important library's

```{r}
library(ggplot2)
library(tidyverse)
library(patchwork)
library(ggpubr)
source("99_proj_func.R")
```

2.  For the analysis of the data we write the cleaned and transformed data frame (**`data`**) to a new TSV file named "03_dat_clean.tsv" in the "../data/" directory.

```{r}
#| message: false
data <- read_tsv("../data/03_dat_aug.tsv")
```

## Data Overview

### **Exploring Age Distribution by Diagnosis**

First, we generate a violin plot graphing the diagnosis of being healthy or sick against age. Which provides a quick and insightful snapshot for initial dataset exploration.

```{r}
#Violin plot
violin_p1 <- ggplot(data = data,
                 aes(x = age,
                     y = diagnose,
                     color = diagnose,
                     fill = diagnose)) +
  geom_violin(alpha = 0.4) +
  scale_fill_manual(values = c("darkgreen", "red")) +
  scale_color_manual(values = c("darkgreen", "red")) +
  theme_minimal()

violin_p1
ggsave(file = "../results/plot_1.png", plot_1, width = 8, height = 6, units = "in")
```

The x-axis represents the age of an individual, ranging from 30 to 70. The y-axis shows the different diagnoses related to heart disease, labeled as "sick" at the top and "healthy" at the bottom. Each diagnosis is visually differentiated by two colors. The "green" color represents a positive health condition ("healthy"), while the "red" color marks a negative health condition ("sick"). On one hand, the red curve is broader, peaking around the age of 50. On the other hand, the green curve is narrower, also peaking around the age of 50 but with a lower amplitude compared to the red curve. In summary the plot shows us that the older the patients are, more likely they are diagnosed by a heart disease. Most diagnosed individuals were between 55 and 65. While the age increases, far this range, the amount of diagnosed individuals decrease. The highest proportion of healthy individuals can be noticed between the approximate ages of 40 and 55, decreasing afterwards.

### **Exploring Numerical Variables by Diagnosis**

Before searching for some more details, we explore some density plots related to selected numerical values. The goal is to create an overview how these numerical variables spread out in each health category and how their density correlates with it.

```{r}
#Plotting the distribution of numerical variables, divided by diagnosis

# Density-plot of age attribute
density_p1 <- dens(data, "age")

# Density-plot of trestbps attribute
density_p2 <- dens(data, "trestbps")

# Density-plot of chol attribute
density_p3 <- dens(data, "chol")

# Density-plot of thalach attribute
density_p4 <- dens(data, "thalach")

# Density-plot of ca attribute
density_p5 <- dens(data, "ca")

# Density-plot of oldpeak attribute
density_p6 <- dens(data, "oldpeak")

# All density plots
density_grid <- ggarrange(density_p1, density_p2, density_p3, density_p4, density_p5, density_p6, ncol=2, nrow=3, common.legend = TRUE, legend = "bottom")

density_grid
ggsave(file = "../results/plot_2.png", density_grid, width = 8, height = 6, units = "in")

```

The result consists of four separate density plots arranged in a grid. Each plot focus on the distribution of a specific health variable - the 'age', 'trestbps', 'chol', and 'thalach'. As in the violin plot, the difference in the diagnosis is represented by the colors 'green' or 'red', indicating whether the individual is healthy or sick.

In the "age" plot, the green curve has a peak around age 55 while the red curve peaks around age 60. This specifies that older people are more likely to be sick then younger people.

In the "trestbps" plot, the curves overlap substantially. Both have a peak around 130 but the red curve is slightly shifted right indicating higher blood pressure in sick individuals.

In the "chol" plot, the curves seem quite similar again but the green curve peaks around 240 while the red curve peaks at about 260 showing higher cholesterol levels in sick persons.

In the "thalach" plot, the curves show a greater difference. Meanwhile, the green curve peaks near 160 while the red one nears its peak at about 140 showing lower maximum heart rates in ill persons. In summary, it suggests that individuals with health diseases tend to have slightly lower maximum heart rates than healthy individuals.

The data was elongated by inserting each numerical variable into one column, called "numerical_variables".

```{r}
model_data <- data |>
  select(diagnose, age, trestbps, chol, thalach, ca, oldpeak) |>
  mutate(diagnose = case_when(diagnose == "healthy" ~ 0,
                              diagnose == "sick" ~ 1)) |>
  pivot_longer(cols = c(age, trestbps, chol, thalach, ca, oldpeak),
               names_to = "numerical_variables",
               values_to = "numerical_value")

model_data
```

The data was then fitted to a simple linear model.

```{r}
fitted_data <- model_data |>
  group_by(numerical_variables) |>
  nest() |>
  mutate(linear_model = map(.x = data,
                            .f = ~lm(numerical_value ~ diagnose,
                                     data = .x))) |> 
  mutate(linear_model_tidy = map(.x = linear_model,
                                 .f = ~tidy(x = .x,
                                            conf.int = TRUE,
                                            conf.level = 0.95))) |>
  unnest(linear_model_tidy) |>
  filter(term == "diagnose") |>
  select(numerical_variables, p.value) |>
  mutate(is.significant = case_when(p.value <= 0.05 ~ "yes",
                                    p.value > 0.05 ~ "no"))

fitted_data
```

The linear models support that the 'chol' variable (cholesterol levels) is not significantly correlated to the diagnosis of a patient. Opposite from what was concluded from viewing the density plot, the 'trestbps' variable (resting blood pressure ) does show a correlation, though the p-value is higher for this variable compared to the remaining ones, 'age' and 'thalach' (maximum heart rate).

### **Exploring Categorical Variables by Diagnosis**

In the following, we create a series of bar plots examining the distribution of various categorical variables in relation to different diagnoses.

```{r}
# Plotting the disctribution of categorical variables, divided by diagnosis

# Bar-plot of cp attribute
bar_p1 <- bar(data, "cp")

# Bar-plot of thal attribute
bar_p2 <- bar(data, "thal")

# Bar-plot of fbs attribute
bar_p3 <- bar(data, "fbs")

# Bar-plot of exang attribute
bar_p4 <- bar(data, "exang")

# Bar-plot of restecg attribute
bar_p5 <- bar(data, "restecg")

# Bar-plot of slope attribute
bar_p6 <- bar(data, "slope")

# All bar plots
bar_grid <- ggarrange(bar_p1, bar_p2, bar_p3, bar_p4, bar_p5, bar_p6, ncol = 2, nrow = 3, common.legend = TRUE, legend = "bottom")
bar_grid
ggsave(file = "../results/plot_3.png", bar_grid, width = 8, height = 6, units = "in")

```

The provided plot shows a series of bar plots comparing the health status (healthy or sick) of individuals based on various categorical variables including chest pain type, fasting blood sugar, resting electrocardiographic results, exercise induced angina, and thallium heart scan.

The "cp" plot shows that asymptomatic individuals are categorized as sick while individuals with atypical angina, non-anignal pain and typical angina are mostly healthy.

In the "thal" plot, those with a reversible defect are mostly sick, while those with normal results are for the most part healthy.

The "fbs" plot shows that the "fbs" variable doesn't make a huge difference if a individual is diagnosed as either healthy or sick, both people with lower than 120mg/ml and greater than 120mg/ml have similar proportions.

In the "exang" plot, it's shown that the individuals have an occurrence of exercise-induced angina are primarly sick. Those with an absence of exercise-induced angina are largely healthy.

For "restecg", individuals with ST-T wave abnormality are most likely sick. others in this category lean towards being diagnosed as healthy. People having left ventricular hyperthrophy have a equal proportion of being either healthy or sick.

In the last plot labeled "ca", as the count increases from 0 to 3, there is an increasing trend in being diagnosed as sick. So, more blockages or issues in the big blood vessels correlate with being sick.

### Discussion

From the visualization and linear models, we've formed a general understanding of our data, and the relationship between the diagnosis of a patient, and all other attributes. 

The numerical variables which showed the strongest linear correlation to the diagnosis, were 'ca', 'oldpeak', and 'thalach'. This result makes sense when comparing it to the density-plots, which also showed good separation between healthy and sick patients for these attributes. 

Many of the categorial variables showed potential for separating healthy from sick patients, except for the fasting blood sugar ('fbs'), which was relatively equal for the two groups. One of the attributes which showed the best separation was chest pain ('cp'), which is an attribute that will be looked further into for the remaining analysis.

