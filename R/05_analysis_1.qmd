---
format:
  revealjs:
    embed-resources: true
---

# Analysis of data

```{r}
library(ggplot2)
library(tidyverse)
library(patchwork)
library(ggpubr)
source("99_proj_func.R")
```

```{r}
#| message: false
data <- read_tsv("../data/03_dat_aug.tsv")
```

## Getting an overview of the sample

```{r}
#Violin plot
ggplot(data = data,
       aes(x = age,
           y = diagnose,
           color = diagnose,
           fill = diagnose)) +
  geom_violin(alpha = 0.4) +
  scale_fill_manual(values = c("darkgreen", "red")) +
  scale_color_manual(values = c("darkgreen", "red")) +
  theme_minimal()

```

The plot shows us there is an uneven distribution between the observations which are diagnosed and not diagnosed. The distribution of non-diagnose patients is relatively even, while the distribution of diagnosed patients is larger around the age-group 55-60 years.

### Distribution between continuous variables

```{r}
#Plotting the distribution of numerical variables, divided by diagnosis

# Density-plot of age attribute
density_p1 <- dens(data, "age")

# Density-plot of trestbps attribute
density_p2 <- dens(data, "trestbps")

# Density-plot of chol attribute
density_p3 <- dens(data, "chol")

# Density-plot of thalach attribute
density_p4 <- dens(data, "thalach")

# Density-plot of ca attribute
density_p5 <- dens(data, "ca")

# Density-plot of oldpeak attribute
density_p6 <- dens(data, "oldpeak")

# All density plots
ggarrange(density_p1, density_p2, density_p3, density_p4, density_p5, density_p6, ncol=2, nrow=3, common.legend = TRUE, legend = "bottom")
```

The plots show that, out of the four variables included in the analysis, that 'age' and 'thalach' seem to be the best at separating healthy and sick patients, as their peaks are in relatively different positions. To investigate this relationship, we're doing a linear model for each numerical variable.

The data was elongated by inserting each numerical variable into one column, called "numerical_variables".

```{r}
model_data <- data |>
  select(diagnose, age, trestbps, chol, thalach, ca, oldpeak) |>
  mutate(diagnose = case_when(diagnose == "healthy" ~ 0,
                              diagnose == "sick" ~ 1)) |>
  pivot_longer(cols = c(age, trestbps, chol, thalach, ca, oldpeak),
               names_to = "numerical_variables",
               values_to = "numerical_value")

model_data
```

The data was then fitted to a simple linear model.

```{r}
fitted_data <- model_data |>
  group_by(numerical_variables) |>
  nest() |>
  mutate(linear_model = map(.x = data,
                            .f = ~lm(numerical_value ~ diagnose,
                                     data = .x))) |> 
  mutate(linear_model_tidy = map(.x = linear_model,
                                 .f = ~tidy(x = .x,
                                            conf.int = TRUE,
                                            conf.level = 0.95))) |>
  unnest(linear_model_tidy) |>
  filter(term == "diagnose") |>
  select(numerical_variables, p.value) |>
  mutate(is.significant = case_when(p.value <= 0.05 ~ "yes",
                                    p.value > 0.05 ~ "no"))

fitted_data
```

The linear models support that the 'chol' variable (cholesterol levels) is not significantly correlated to the diagnosis of a patient. Opposite from what was concluded from viewing the density plot, the 'trestbps' variable (resting blood pressure ) does show a correlation, though the p-value is higher for this variable compared to the remaining ones, 'age' and 'thalach' (maximum heart rate).

### Distribution of categorical variables

```{r}
# Plotting the disctribution of categorical variables, divided by diagnosis

# Bar-plot of cp attribute
bar_p1 <- bar(data, "cp")

# Bar-plot of thal attribute
bar_p2 <- bar(data, "thal")

# Bar-plot of fbs attribute
bar_p3 <- bar(data, "fbs")

# Bar-plot of exang attribute
bar_p4 <- bar(data, "exang")

# Bar-plot of restecg attribute
bar_p5 <- bar(data, "restecg")

# Bar-plot of slope attribute
bar_p6 <- bar(data, "slope")

# All bar plots
ggarrange(bar_p1, bar_p2, bar_p3, bar_p4, bar_p5, bar_p6, ncol = 2, nrow = 3, common.legend = TRUE, legend = "bottom")


```

The plots show us that the variables fbs and restecg are not the best at separating diagnosed from undiagnosed patients, while cp, exang, thal, and ca do show separation between the two.

### Slope and oldpeak

```{r}
ggplot(data, 
       aes(x = slope,
           fill = diagnose,
           color = diagnose)) + 
  geom_bar(alpha = 0.4,
           position = "fill") +
  scale_fill_manual(values = c("darkgreen", "red")) +
  scale_color_manual(values = c("darkgreen", "red")) + 
  labs(title = "Boxplot of Slope by Diagnosis",
       x = "Slope") +
  theme_minimal() +
  theme(legend.position = "bottom",  
        plot.title = element_text(hjust = 0.5),  
        axis.title.x = element_text(face = "bold"), 
        axis.title.y = element_text(face = "bold")) 
```

The plot shows us that downward and flat slopes could be good indicators of heart disease.

```{r}
ggplot(data, 
       aes(x = diagnose, 
           y = oldpeak, 
           color = diagnose,
           fill = diagnose)) + 
  geom_boxplot(alpha = 0.4) +
  scale_fill_manual(values = c("darkgreen", "red")) + 
  scale_color_manual(values = c("darkgreen", "red")) + 
  labs(title = "Boxplot of Oldpeak by Diagnosis",
       x = "diagnose",
       y = "Oldpeak Value") +
  theme_minimal() +  
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face = "bold"), 
        axis.title.y = element_text(face = "bold")) 
```

These two plots show that the patients are more likely to be diagnose with heart diseases with higher oldpeak and abnormal slope such as flat and downsloping ST segment.

### Results

From the visualization, we have formed a general overview and understanding of our data. We are now interested in variables as follows: the relationship of 'age', 'thalach - max heart rate', 'cp','thal','exang','ca','slope','oldpeak' with 'diagnose'. The further analysis will be conducted in the next file.
